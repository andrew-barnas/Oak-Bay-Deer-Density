SECR Models manuscript verison! The goals here are to make all the minor tweaks to the model that we can

Things I have added
1. Baseline model - July 11th 


```{r}
#Clear everything out, its probably messy from the data prep file
rm(list = ls())

#Packages we will need
library(reproducible) #setting up directories for data management
library(dplyr)        #data wranglin'
library(ggplot2)      #data visualization
library(stringr)      #reading information on strings
library(secr)         #the actual model engine
library(ggtext)       #Superscript on ggplot axis title
library(sf)           #Spatial data

#Set the working directories to read in the files we need
input_directory<-reproducible::checkPath(file.path(getwd(), "2. SECR Prep/outputs"), create = TRUE)
output_directory<-reproducible::checkPath(file.path(getwd(), "3. SECR Models/outputs"), create = TRUE)
figure_directory<-reproducible::checkPath(file.path(getwd(), "3. SECR Models/figures"), create = TRUE)
shapefiles_directory<-reproducible::checkPath(file.path(getwd(), "3. SECR Models/shapefiles2"), create = TRUE)



```

Baseline model
```{r}
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)

fit1_baseline<-secr.fit(deer_secr_2018, buffer = 1000,trace = TRUE)
fit1_baseline

#Extract estimate (deer/ha) and convert to deer per km2
fit1_mean<-(summary(fit1_baseline)[["predicted"]][["estimate"]][[1]]) *100
fit1_upper<-(summary(fit1_baseline)[["predicted"]][["ucl"]][[1]]) *100
fit1_lower<-(summary(fit1_baseline)[["predicted"]][["lcl"]][[1]]) *100

#Wrap those into a dataframe
df<-data.frame(model = c("baseline"),
                mean = fit1_mean,
                upper = fit1_upper,
                lower = fit1_lower
               )

```

Adding unmarked sightings
```{r}
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

fit2_baseline_with_sightings<-secr.fit(deer_secr_2018, buffer = 1000,trace = TRUE)
browseURL("https://www.youtube.com/watch?v=NUYvbT6vTPs")
fit2_baseline_with_sightings


#Extract estimate (deer/ha) and convert to deer per km2
fit2_mean<-(summary(fit2_baseline_with_sightings)[["predicted"]][["estimate"]][[1]]) *100
fit2_upper<-(summary(fit2_baseline_with_sightings)[["predicted"]][["ucl"]][[1]]) *100
fit2_lower<-(summary(fit2_baseline_with_sightings)[["predicted"]][["lcl"]][[1]]) *100

#Wrap those into the growing dataframe
temp<-data.frame(model = c("added_sightings"),
                mean = fit2_mean,
                upper = fit2_upper,
                lower = fit2_lower
               )

df<-rbind(df, temp)


```

Adjusting for overdispersion
```{r}
start_time<-Sys.time()
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

#Fit the initial model
fit<-secr.fit(deer_secr_2018, buffer = 1000,trace = TRUE)

#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit3_adjust_overdispersion <- secr.fit(deer_secr_2018, buffer = 1000, trace = FALSE, #this lines repeats the model specification from fit1
                      start = fit, details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

fit3_adjust_overdispersion

#Extract estimate (deer/ha) and convert to deer per km2
fit3_mean<-(summary(fit3_adjust_overdispersion)[["predicted"]][["estimate"]][[1]]) *100
fit3_upper<-(summary(fit3_adjust_overdispersion)[["predicted"]][["ucl"]][[1]]) *100
fit3_lower<-(summary(fit3_adjust_overdispersion)[["predicted"]][["lcl"]][[1]]) *100


#Wrap those into the growing dataframe
temp<-data.frame(model = c("overdispersion_adjust"),
                mean = fit3_mean,
                upper = fit3_upper,
                lower = fit3_lower
               )
df<-rbind(df, temp)

#Tell me when its done!
browseURL("https://www.youtube.com/watch?v=NUYvbT6vTPs")

#I just like to know how long this takes
end_time<-Sys.time()
end_time - start_time

```


Specify Half Normal Detection Function
```{r}
start_time<-Sys.time()
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

#Fit the initial model
fit<-secr.fit(deer_secr_2018, 
              buffer = 1000,
              detectfn = "HN", #Half normal detection function
              trace = TRUE)

#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit4_half_normal_df <- secr.fit(deer_secr_2018, 
                                       buffer = 1000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

fit4_half_normal_df

#Extract estimate (deer/ha) and convert to deer per km2
fit4_mean<-(summary(fit4_half_normal_df)[["predicted"]][["estimate"]][[1]]) *100
fit4_upper<-(summary(fit4_half_normal_df)[["predicted"]][["ucl"]][[1]]) *100
fit4_lower<-(summary(fit4_half_normal_df)[["predicted"]][["lcl"]][[1]]) *100


#Wrap those into the growing dataframe
temp<-data.frame(model = c("half_normal_df"),
                mean = fit4_mean,
                upper = fit4_upper,
                lower = fit4_lower
               )
df<-rbind(df, temp)

#Save the dataframe so I can recover it if my tests make R crash
write.csv(df, file.path(output_directory, "secr_tests_df.csv"))

#Tell me when its done!
browseURL("https://www.youtube.com/watch?v=NUYvbT6vTPs")

#I just like to know how long this takes
end_time<-Sys.time()
end_time - start_time

```

Make sure modeled as Poisson
```{r}
start_time<-Sys.time()
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

#Fit the initial model
fit<-secr.fit(deer_secr_2018, 
              buffer = 1000,
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit5_poisson <- secr.fit(deer_secr_2018, 
                                       buffer = 1000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

fit5_poisson

#Extract estimate (deer/ha) and convert to deer per km2
fit5_mean<-(summary(fit5_poisson)[["predicted"]][["estimate"]][[1]]) *100
fit5_upper<-(summary(fit5_poisson)[["predicted"]][["ucl"]][[1]]) *100
fit5_lower<-(summary(fit5_poisson)[["predicted"]][["lcl"]][[1]]) *100


#Wrap those into the growing dataframe
temp<-data.frame(model = c("poisson"),
                mean = fit5_mean,
                upper = fit5_upper,
                lower = fit5_lower
               )
df<-rbind(df, temp)

#Save the dataframe so I can recover it if my tests make R crash
write.csv(df, file.path(output_directory, "secr_tests_df.csv"))

#Tell me when its done!
browseURL("https://www.youtube.com/watch?v=NUYvbT6vTPs")

#I just like to know how long this takes
end_time<-Sys.time()
end_time - start_time

```



Show me the growing plot!
```{r}

#Reorder the models
df$model<-factor(df$model, levels =c("baseline",
                                      "added_sightings",
                                      "overdispersion_adjust",
                                     "half_normal_df",
                                     "poisson"))

ggplot(df, aes(x =model, y = mean))+
  geom_point()+
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2)+
  #ylab("Anthropogenic SO<sub>4</sub><sup>2-</sup> (ngm<sup>-3</sup>)")+
  ylab("Individuals<sup>-km2</sup> \u00B1 95% CI")+
  xlab("Model-fication")+
  ggtitle("Model structure impacts on density estimates")+
  theme_classic()+
  theme(axis.text.y =element_text(size = 12, color = "black"),
        axis.title.y =element_markdown(size = 15, face = "bold", color = "black"),
        axis.text.x = element_text(size = 15, color = "black"),
         axis.title.x = element_blank())
```



#############################################################################################################
#############################################################################################################
#############################################################################################################
PLAYING WITH BUFFERS

How sensitive are the estimates to buffer size?
```{r}
#The original model above used a 1000m buffer, so what about a 500m and 2000m buffer?
df_buffer<-df%>%
  filter(model == "poisson")%>%
  select(-c(model))%>%
  mutate(buffer = 1000)

#Refit the models with 500m 
start_time<-Sys.time()
#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

#Fit the initial model
fit<-secr.fit(deer_secr_2018, 
              buffer = 500,
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit6_b500 <- secr.fit(deer_secr_2018, 
                                       buffer = 500, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)


#Extract estimate (deer/ha) and convert to deer per km2
fit6_mean<-(summary(fit6_b500)[["predicted"]][["estimate"]][[1]]) *100
fit6_upper<-(summary(fit6_b500)[["predicted"]][["ucl"]][[1]]) *100
fit6_lower<-(summary(fit6_b500)[["predicted"]][["lcl"]][[1]]) *100


#Wrap those into the growing dataframe
temp<-data.frame(buffer = 500,
                mean = fit6_mean,
                upper = fit6_upper,
                lower = fit6_lower
               )
df_buffer<-rbind(df_buffer, temp)







########################################################################
#And then again for 2000

#Create a capture history object using the above created text files
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)


#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)

#Fit the initial model
fit<-secr.fit(deer_secr_2018, 
              buffer = 2000,
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit6_b2000 <- secr.fit(deer_secr_2018, 
                                       buffer = 2000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)


#Extract estimate (deer/ha) and convert to deer per km2
fit7_mean<-(summary(fit6_b2000)[["predicted"]][["estimate"]][[1]]) *100
fit7_upper<-(summary(fit6_b2000)[["predicted"]][["ucl"]][[1]]) *100
fit7_lower<-(summary(fit6_b2000)[["predicted"]][["lcl"]][[1]]) *100


#Wrap those into the growing dataframe
temp<-data.frame(buffer = 2000,
                mean = fit7_mean,
                upper = fit7_upper,
                lower = fit7_lower
               )
df_buffer<-rbind(df_buffer, temp)


#Save the dataframe so I can recover it if my tests make R crash
write.csv(df_buffer, file.path(output_directory, "secr_tests_df_buffers.csv"))
#Tell me when its done!
browseURL("https://www.youtube.com/watch?v=NUYvbT6vTPs")
#I just like to know how long this takes
end_time<-Sys.time()
end_time - start_time

```

Habitat Masks
```{r}
#Heres the capture history object
deer_secr_2018
#And here is the fitted model
fit5_poisson

#What does the mask for this look like?
par(mar = c(1,1,1,1))
plot(fit5_poisson$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2018), detpar = list(pch = 16, cex = 1), add = TRUE)

#Pilot estimate for buffer width
RPSV(deer_secr_2018, CC= TRUE)

#What is the suggested buffer?
suggest.buffer(fit5_poisson)

#Ok now lets check out the plot
par(pty = "s", mar = c(4,4,2,2), mgp = c(2.5, 0.8, 0), las = 1)
esa.plot(fit5_poisson, ylim = c(0,10))
abline(v = 4*RPSV(deer_secr_2018, CC= TRUE), col = "red", lty = 2 )
abline(v = suggest.buffer(fit5_poisson), col = "blue", lty = 2 )


```

Trying this shit with a custom mask
```{r}
#Ok first thing, read in the shape file
oak_bay_clipped<-st_read("3. SECR Models/shapefiles/new_cams_Buffer1_Erase.shp")

test<-make.mask(traps(deer_secr_2018), 
                type = "trapbuffer", 
                buffer = 1500,
                poly = oak_bay_clipped)

#What does the mask for this look like? So this will not allow buffers greater than 1000m based on our clipped oak bay mask!
par(mar = c(1,1,1,1))
plot(test, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2018), detpar = list(pch = 16, cex = 1), add = TRUE)

#mask area in hectares
maskarea(test)

#mask area in km2
maskarea(test)/100

```

Ok lets run through the whole process
```{r}
start_time<-Sys.time()

#First create a capture history object using the above created text files. This is our base secr object
deer_secr_2018<-read.capthist(captfile = file.path(input_directory, "captures_2018.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2018.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2018)

#This shows a plot of detections for individuals
#Good to inspect that you dont have an individual located on traps on completely different 
#sides of the study area (unlikely, would indicate an error likely - unless the move A LOT)
png(file.path(figure_directory, "deer_secr_2018_tracks.jpeg"), width = 400, height = 600)
plot(deer_secr_2018, tracks = TRUE)
dev.off()

#Lets add the unmarked sightings to the capture history object
deer_secr_2018<-addSightings(deer_secr_2018, unmarked = file.path(input_directory, "unmarked_matrix_2018.txt"), skip = 1)
summary(deer_secr_2018)


#Next, read in the habitat mask we will be using, with an initial 1000m buffer
oak_bay_clipped_2018<-st_read("3. SECR Models/shapefiles/new_cams_Buffer1_Erase.shp")
oak_bay_clipped_2018<-st_read(file.path(shapefiles_directory, "cameras_2018_clipped.shp"))
#Use that shape file to create a habitat mask for the initial model
mask_2018<-make.mask(traps(deer_secr_2018), 
                type = "trapbuffer", 
                buffer = 1000, 
                poly = oak_bay_clipped_2018)



#Fit the initial model
fit<-secr.fit(deer_secr_2018, 
              mask = mask_2018, #Specify the habitat mask
             # buffer = 1500,   #No need to specify a buffer here, since we have a mask
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#Inspect the mask!
par(mar = c(1,1,1,1))
plot(fit$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2018), detpar = list(pch = 16, cex = 1), add = TRUE)



#Perform Retrospective buffer checks
#Pilot estimate for buffer width. 4* this value is a suggested buffer risk
RPSV_2018<-4*RPSV(deer_secr_2018, CC= TRUE)

#What is the suggested buffer from the initial fitted model
suggested_buffer_2018<-suggest.buffer(fit)

#Save the esa plot to a dataframe for plotting
A<-esa.plot(fit, ylim = c(0,10))

esa_plot_2018<-ggplot(A, aes(x = buffer, y = density))+
  geom_line()+
  geom_vline(aes(xintercept = RPSV_2018), color = "blue", linetype = "longdash")+
  geom_vline(aes(xintercept = suggested_buffer_2018), color = "firebrick3", linetype = "longdash")+
  annotate("text", x = RPSV_2018 + 40, y = 20, label = "4*RPSV")+
  annotate("text", x = suggested_buffer_2018 + 50, y = 20, label = "suggest.buffer")+
  ylab("Predicted change in density")+
  xlab("Buffer width (m)")+
  theme_classic()+
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))

ggsave(filename = "esa_plot_2018.jpeg", #name of file
       plot = esa_plot_2018,                 #plot you want to save
       path = figure_directory,            #where it's saved
       width = 2500,                       #how wide
       height = 2500,                      #how tall
        units = "px",                      #units in pixels
        bg = 'white')                      #make sure background is white


#Based ont he recommendations of the guidebook, the penalty for using an over wie buffer is that fitting will be slower for a given mask spacing, it is usually smart to accept this penalty rather than search for the narrowest acceptabel buffer. 
buffer_2018<-suggest.buffer(fit)

#Create a new mask based on this
mask_2018<-make.mask(traps(deer_secr_2018), 
                type = "trapbuffer", 
                buffer = buffer_2018,
                poly = oak_bay_clipped_2018)



#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit8_suggested_buffer <- secr.fit(deer_secr_2018, 
                                       mask = mask_2018,
                                       #buffer = 1000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

#Inspect the revised mask! Need to export this better. 
par(mar = c(1,1,1,1))
plot(fit8_suggested_buffer$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2018), detpar = list(pch = 16, cex = 1), add = TRUE)


#Extract estimate (deer/ha) and convert to deer per km2
fit8_mean<-(summary(fit8_suggested_buffer)[["predicted"]][["estimate"]][[1]]) *100
fit8_upper<-(summary(fit8_suggested_buffer)[["predicted"]][["ucl"]][[1]]) *100
fit8_lower<-(summary(fit8_suggested_buffer)[["predicted"]][["lcl"]][[1]]) *100



save(fit8_suggested_buffer, file = file.path(output_directory, "fit8_suggested_buffer.RData"))



```



2022 Model
```{r}
start_time<-Sys.time()

#First create a capture history object using the above created text files. This is our base secr object
deer_secr_2022<-read.capthist(captfile = file.path(input_directory, "captures_2022.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2022.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2022)

#This shows a plot of detections for individuals
#Good to inspect that you dont have an individual located on traps on completely different 
#sides of the study area (unlikely, would indicate an error likely - unless the move A LOT)
png(file.path(figure_directory, "deer_secr_2022_tracks.jpeg"), width = 400, height = 600)
plot(deer_secr_2022, tracks = TRUE)
dev.off()

#Lets add the unmarked sightings to the capture history object
deer_secr_2022<-addSightings(deer_secr_2022, unmarked = file.path(input_directory, "unmarked_matrix_2022.txt"), skip = 1)
summary(deer_secr_2022)


#Next, read in the habitat mask we will be using, with an initial 1000m buffer
oak_bay_clipped_2022<-st_read(file.path(shapefiles_directory, "cameras_2022_clipped.shp"))
#Use that shape file to create a habitat mask for the initial model
mask_2022<-make.mask(traps(deer_secr_2022), 
                type = "trapbuffer", 
                buffer = 1000, 
                poly = oak_bay_clipped_2022)



#Fit the initial model
fit<-secr.fit(deer_secr_2022, 
              mask = mask_2022, #Specify the habitat mask
             # buffer = 1500,   #No need to specify a buffer here, since we have a mask
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#Inspect the mask!
par(mar = c(1,1,1,1))
plot(fit$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2022), detpar = list(pch = 16, cex = 1), add = TRUE)



#Perform Retrospective buffer checks
#Pilot estimate for buffer width. 4* this value is a suggested buffer risk
RPSV_2022<-4*RPSV(deer_secr_2022, CC= TRUE)

#What is the suggested buffer from the initial fitted model
suggested_buffer_2022<-suggest.buffer(fit)

#Save the esa plot to a dataframe for plotting
A<-esa.plot(fit, ylim = c(0,10))

esa_plot_2022<-ggplot(A, aes(x = buffer, y = density))+
  geom_line()+
  geom_vline(aes(xintercept = RPSV_2022), color = "blue", linetype = "longdash")+
  geom_vline(aes(xintercept = suggested_buffer_2022), color = "firebrick3", linetype = "longdash")+
  annotate("text", x = RPSV_2022 -50, y = 40, label = "4*RPSV")+
  annotate("text", x = suggested_buffer_2022 + 60, y = 20, label = "suggest.buffer")+
  ylab("Predicted change in density")+
  xlab("Buffer width (m)")+
  theme_classic()+
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))

ggsave(filename = "esa_plot_2022.jpeg", #name of file
       plot = esa_plot_2022,                 #plot you want to save
       path = figure_directory,            #where it's saved
       width = 2500,                       #how wide
       height = 2500,                      #how tall
        units = "px",                      #units in pixels
        bg = 'white')                      #make sure background is white


#Based ont he recommendations of the guidebook, the penalty for using an over wie buffer is that fitting will be slower for a given mask spacing, it is usually smart to accept this penalty rather than search for the narrowest acceptabel buffer. 
buffer_2022<-suggest.buffer(fit)

#Create a new mask based on this
mask_2022<-make.mask(traps(deer_secr_2022), 
                type = "trapbuffer", 
                buffer = buffer_2022,
                poly = oak_bay_clipped_2022)



#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit2022_suggested_buffer <- secr.fit(deer_secr_2022, 
                                       mask = mask_2022,
                                       #buffer = 1000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

#Inspect the revised mask! Need to export this better. 
par(mar = c(1,1,1,1))
plot(fit2022_suggested_buffer$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2022), detpar = list(pch = 16, cex = 1), add = TRUE)


#Extract estimate (deer/ha) and convert to deer per km2
fit2022_mean<-(summary(fit2022_suggested_buffer)[["predicted"]][["estimate"]][[1]]) *100
fit2022_upper<-(summary(fit2022_suggested_buffer)[["predicted"]][["ucl"]][[1]]) *100
fit2022_lower<-(summary(fit2022_suggested_buffer)[["predicted"]][["lcl"]][[1]]) *100



save(fit2022_suggested_buffer, file = file.path(output_directory, "fit2022_suggested_buffer.RData"))

```

2023 Model
```{r}
start_time<-Sys.time()

#First create a capture history object using the above created text files. This is our base secr object
deer_secr_2023<-read.capthist(captfile = file.path(input_directory, "captures_2023.txt"), 
                         trapfile = file.path(input_directory, "deer_cameras_2023.txt"),
                         detector = "count", #this is a proximity detector (records presence at a point without restricting movement)
                         #but allows >1 detection per animal per time
                         markocc = rep(0,30), #This is a vector of n = number of occassions, all zeros indicate no marking done, this is ALL resighting data
                         skip = 1, #Skip = 1 says don't read the first row, which is the headers!
                         verify = TRUE) #Checks to make sure sampling occassions, effort, etc. all match up    
summary(deer_secr_2023)

#This shows a plot of detections for individuals
#Good to inspect that you dont have an individual located on traps on completely different 
#sides of the study area (unlikely, would indicate an error likely - unless the move A LOT)
png(file.path(figure_directory, "deer_secr_2023_tracks.jpeg"), width = 400, height = 600)
plot(deer_secr_2023, tracks = TRUE)
dev.off()

#Lets add the unmarked sightings to the capture history object
deer_secr_2023<-addSightings(deer_secr_2023, unmarked = file.path(input_directory, "unmarked_matrix_2023.txt"), skip = 1)
summary(deer_secr_2023)


#Next, read in the habitat mask we will be using, with an initial 1000m buffer
oak_bay_clipped_2023<-st_read(file.path(shapefiles_directory, "cameras_2023_clipped.shp"))
#Use that shape file to create a habitat mask for the initial model
mask_2023<-make.mask(traps(deer_secr_2023), 
                type = "trapbuffer", 
                buffer = 1000, 
                poly = oak_bay_clipped_2023)



#Fit the initial model
fit<-secr.fit(deer_secr_2023, 
              mask = mask_2023, #Specify the habitat mask
             # buffer = 1500,   #No need to specify a buffer here, since we have a mask
              detectfn = "HN", #Half normal detection function
              binomN = 0,      #Specify detections as a Poisson process
              trace = TRUE)

#Inspect the mask!
par(mar = c(1,1,1,1))
plot(fit$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2023), detpar = list(pch = 16, cex = 1), add = TRUE)



#Perform Retrospective buffer checks
#Pilot estimate for buffer width. 4* this value is a suggested buffer risk
RPSV_2023<-4*RPSV(deer_secr_2023, CC= TRUE)

#What is the suggested buffer from the initial fitted model
suggested_buffer_2023<-suggest.buffer(fit)

#Save the esa plot to a dataframe for plotting
A<-esa.plot(fit, ylim = c(0,10))

esa_plot_2023<-ggplot(A, aes(x = buffer, y = density))+
  geom_line()+
  geom_vline(aes(xintercept = RPSV_2023), color = "blue", linetype = "longdash")+
  geom_vline(aes(xintercept = suggested_buffer_2023), color = "firebrick3", linetype = "longdash")+
  annotate("text", x = RPSV_2023 -50, y = 40, label = "4*RPSV")+
  annotate("text", x = suggested_buffer_2023 + 60, y = 20, label = "suggest.buffer")+
  ylab("Predicted change in density")+
  xlab("Buffer width (m)")+
  theme_classic()+
  theme(axis.title.x = element_text(size = 15),
        axis.title.y = element_text(size = 15),
        axis.text.x = element_text(size = 12),
        axis.text.y = element_text(size = 12))

ggsave(filename = "esa_plot_2023.jpeg", #name of file
       plot = esa_plot_2023,                 #plot you want to save
       path = figure_directory,            #where it's saved
       width = 2500,                       #how wide
       height = 2500,                      #how tall
        units = "px",                      #units in pixels
        bg = 'white')                      #make sure background is white


#Based ont he recommendations of the guidebook, the penalty for using an over wie buffer is that fitting will be slower for a given mask spacing, it is usually smart to accept this penalty rather than search for the narrowest acceptabel buffer. 
buffer_2023<-suggest.buffer(fit)

#Create a new mask based on this
mask_2023<-make.mask(traps(deer_secr_2023), 
                type = "trapbuffer", 
                buffer = buffer_2023,
                poly = oak_bay_clipped_2023)



#What about overdispersion??
#1. fit the model ASSUMING NO OVERDISPERSION
#2. Estimate the overdispersion by simulating at the initial estimates
#3. Re-fit the model using an overdispersion-adjusted pseudo-likelioo
fit2023_suggested_buffer <- secr.fit(deer_secr_2023, 
                                       mask = mask_2023,
                                       #buffer = 1000, 
                                       trace = FALSE, 
                                        detectfn = "HN", #Half normal detection function
                                        binomN = 0,      #Specify detections as a Poisson process
                                       start = fit, #this lines repeats the model specification from fit1
                       details = list(nsim = 10000)) #this line gives the previous model fit1 as a starting point, calls nsim simulations to estimated overdispersion (c-hat)

#Inspect the revised mask! Need to export this better. 
par(mar = c(1,1,1,1))
plot(fit2023_suggested_buffer$mask, dots = FALSE, mesh = "grey", col = "white")
plot(traps(deer_secr_2023), detpar = list(pch = 16, cex = 1), add = TRUE)


#Extract estimate (deer/ha) and convert to deer per km2
fit2023_mean<-(summary(fit2023_suggested_buffer)[["predicted"]][["estimate"]][[1]]) *100
fit2023_upper<-(summary(fit2023_suggested_buffer)[["predicted"]][["ucl"]][[1]]) *100
fit2023_lower<-(summary(fit2023_suggested_buffer)[["predicted"]][["lcl"]][[1]]) *100



save(fit2023_suggested_buffer, file = file.path(output_directory, "fit2023_suggested_buffer.RData"))


```

Now plot the estimates from each model
```{r}
#Load in the data we need
load(file.path(output_directory, "fit8_suggested_buffer.RData"))

load(file.path(output_directory, "fit2023_suggested_buffer.RData"))


#Extract the estimates for each year and wrap them into a dataframe
#Extract estimate (deer/ha) and convert to deer per km2
mean_density_2018<-(summary(fit8_suggested_buffer)[["predicted"]][["estimate"]][[1]]) *100
upper_density_CI_2018<-(summary(fit8_suggested_buffer)[["predicted"]][["ucl"]][[1]]) *100
lower_density_CI_2018<-(summary(fit8_suggested_buffer)[["predicted"]][["lcl"]][[1]]) *100


mean_density_2023<-(summary(fit9_suggested_buffer)[["predicted"]][["estimate"]][[1]]) *100
upper_density_CI_2023<-(summary(fit9_suggested_buffer)[["predicted"]][["ucl"]][[1]]) *100
lower_density_CI_2023<-(summary(fit9_suggested_buffer)[["predicted"]][["lcl"]][[1]]) *100

density_estimates<-data.frame(year= c(2018, 2019, 2020, 2021, 2022, 2023),
                              mean_density = c(mean_density_2018, mean_density_2019, mean_density_2020, mean_density_2021, mean_density_2022, mean_density_2023),
           upper = c(upper_density_CI_2018, upper_density_CI_2019, upper_density_CI_2020, upper_density_CI_2021, upper_density_CI_2022, upper_density_CI_2023),
           lower = c(lower_density_CI_2018, lower_density_CI_2019, lower_density_CI_2020, lower_density_CI_2021, lower_density_CI_2022, lower_density_CI_2023))


density_estimates<-data.frame(year= c(2018, 2023),
                              mean_density = c(mean_density_2018, mean_density_2023),
           upper = c(upper_density_CI_2018,upper_density_CI_2023),
           lower = c(lower_density_CI_2018,lower_density_CI_2023))


ggplot(density_estimates, aes(x = as.factor(year), y = mean_density))+
  geom_point()+
  geom_errorbar(aes(ymin = lower, ymax = upper), width = 0.2)+
  #ylab("Anthropogenic SO<sub>4</sub><sup>2-</sup> (ngm<sup>-3</sup>)")+
  ylab("Individuals<sup>-km2</sup> \u00B1 95% CI")+
  xlab("Year")+
  ggtitle("Preliminary Oak Bay Deer Density Estimates")+
  theme_classic()+
  theme(axis.text.y =element_text(size = 12, color = "black"),
        axis.title.y =element_markdown(size = 15, face = "bold", color = "black"),
        axis.text.x = element_text(size = 15, color = "black"),
         axis.title.x = element_blank())


```